<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Chat on Everything Admin</title>
  <link rel="icon" href="/assets/title_plain.png" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/css/admin.css">
</head>

<body>
  <div id="app">
    <header>
      <button id="mode-toggle-btn" title="Toggle Passive/Active Mode">ğŸ‘</button>
      <button id="remote-control-btn" title="Remote Control">ğŸ®</button>
      <h1>Admin Panel</h1>
      <p>Moderate messages and control settings</p>
      <div class="status">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Disconnected</span>
      </div>
    </header>

    <!-- Login Panel -->
    <div id="login-panel">
      <div class="form-group">
        <label>Server Address</label>
        <input type="text" id="server-input" placeholder="192.168.1.100:8765" autocomplete="off" autocapitalize="off">
      </div>
      <div class="form-group">
        <label>Admin Password</label>
        <input type="password" id="password-input" placeholder="Enter admin password" autocomplete="off">
      </div>
      <div class="error" id="login-error"></div>
      <button class="btn btn-primary" id="login-btn">Login</button>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
      <!-- Content loaded dynamically after authentication -->
    </div>
  </div>

  <!-- Remote Control Panel (Full Screen Overlay) -->
  <div id="remote-panel">
    <div class="remote-header">
      <button class="remote-close-btn" id="remote-close-btn">âœ•</button>
      <h2>Remote Control</h2>
      <button class="remote-settings-btn" id="remote-settings-btn">âš™ï¸</button>
    </div>

    <div class="remote-tabs">
      <button class="remote-tab active" data-remote-tab="media">ğŸµ Media</button>
      <button class="remote-tab" data-remote-tab="mouse">ğŸ–±ï¸ Mouse</button>
      <button class="remote-tab" data-remote-tab="keyboard">âŒ¨ï¸ Keyboard</button>
    </div>

    <!-- Media Tab (Combined Media + VLC) -->
    <div class="remote-content active" id="remote-media">
      <div class="media-section">
        <h3>Playback</h3>
        <div class="media-row">
          <button class="media-btn" id="media-prev-btn" title="Previous Track">â®</button>
          <button class="media-btn" id="media-play-btn" title="Play/Pause">â¯</button>
          <button class="media-btn" id="media-next-btn" title="Next Track">â­</button>
        </div>
      </div>
      <div class="media-section">
        <h3>Volume</h3>
        <div class="media-row">
          <button class="media-btn" id="vol-down-btn" title="Volume Down">-</button>
          <button class="media-btn" id="vol-mute-btn" title="Mute">ğŸ”‡</button>
          <button class="media-btn" id="vol-up-btn" title="Volume Up">+</button>
        </div>
      </div>
      <div class="media-section">
        <h3>VLC Options</h3>
        <div class="vlc-row">
          <button class="vlc-btn" data-vlc="fullscreen">â›¶ Fullscreen</button>
          <button class="vlc-btn" data-vlc="shuffle">Shuffle</button>
          <button class="vlc-btn" data-vlc="loop">Loop</button>
        </div>
      </div>
    </div>

    <!-- Mouse Tab -->
    <div class="remote-content" id="remote-mouse">
      <div class="touch-pad" id="touch-pad"></div>
      <div class="mouse-buttons">
        <button class="mouse-btn" id="mouse-left-btn">Left Click</button>
        <button class="mouse-btn" id="mouse-right-btn">Right Click</button>
      </div>
    </div>

    <!-- Keyboard Tab -->
    <div class="remote-content" id="remote-keyboard">
      <!-- Centered Text Input -->
      <div class="keyboard-input-area">
        <input type="text" id="remote-keyboard-input" placeholder="Type here and press Enter to send..."
          autocomplete="off">
      </div>

      <!-- Row 1: Enter, Back, Space -->
      <div class="special-keys">
        <div class="key-row">
          <button class="key-btn" data-key="Enter">â†µ Enter</button>
          <button class="key-btn" data-key="Backspace">âŒ« Back</button>
          <button class="key-btn" data-key="Space">â£ Space</button>
        </div>
      </div>

      <!-- Row 2: Esc, Tab, Del -->
      <div class="special-keys">
        <div class="key-row">
          <button class="key-btn small" data-key="Escape">â‹ Esc</button>
          <button class="key-btn small" data-key="Tab">â‡¥ Tab</button>
          <button class="key-btn small" data-key="Delete">âŒ¦ Del</button>
        </div>
      </div>

      <!-- Arrow D-Pad (Circular Layout) -->
      <div class="arrow-dpad">
        <div class="dpad-container">
          <button class="dpad-btn dpad-up" data-key="ArrowUp">â–²</button>
          <button class="dpad-btn dpad-left" data-key="ArrowLeft">â—€</button>
          <div class="dpad-center"></div>
          <button class="dpad-btn dpad-right" data-key="ArrowRight">â–¶</button>
          <button class="dpad-btn dpad-down" data-key="ArrowDown">â–¼</button>
        </div>
      </div>

      <!-- Navigation Keys: Home/End and PageUp/PageDown as vertical groups -->
      <div class="nav-keys-container">
        <div class="nav-key-group">
          <button class="key-btn small" data-key="Home">â‡± Home</button>
          <button class="key-btn small" data-key="End">â‡² End</button>
        </div>
        <div class="nav-key-group">
          <button class="key-btn small" data-key="PageUp">â‡ PgUp</button>
          <button class="key-btn small" data-key="PageDown">â‡Ÿ PgDn</button>
        </div>
      </div>
    </div>

    <!-- Settings Overlay -->
    <div class="remote-settings-overlay" id="remote-settings-overlay">
      <h3>Remote Settings</h3>
      <div class="settings-row">
        <label>Mouse Sensitivity</label>
        <input type="range" id="mouse-sensitivity" min="0.5" max="3" step="0.1" value="1.5">
      </div>
      <div class="settings-row">
        <label>Scroll Speed</label>
        <input type="range" id="scroll-speed" min="1" max="10" value="3">
      </div>
      <div class="settings-row">
        <label>Invert Scroll</label>
        <div class="toggle">
          <input type="checkbox" id="invert-scroll">
          <span class="toggle-slider"></span>
        </div>
      </div>
      <button class="vlc-btn" id="settings-close-btn" style="margin-top: 24px; width: 100%;">Close Settings</button>
    </div>
  </div>

  <script type="module">
    import { $, escapeHtml, getUserColor } from '/js/utils.js';
    import { LiveChatClient } from '/js/websocket-client.js';

    // Expose globals for dynamic UI script
    window.$ = $;
    window.escapeHtml = escapeHtml;
    window.getUserColor = getUserColor;
    window.chatClient = null;

    // Elements
    const loginPanel = $('login-panel');
    const adminPanel = $('admin-panel');
    const serverInput = $('server-input');
    const passwordInput = $('password-input');
    const loginBtn = $('login-btn');
    const loginError = $('login-error');
    const statusDot = $('status-dot');
    const statusText = $('status-text');
    const modeToggleBtn = $('mode-toggle-btn');

    let chatClient = null;
    let lastServerAddress = '';
    let lastPassword = '';

    // Detect if page is served over HTTPS (secure tunnel)
    const isSecure = window.location.protocol === 'https:';

    // Load saved values
    const isLocalUrl = !isSecure &&
      (window.location.hostname === 'localhost' ||
        window.location.hostname.match(/^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/) ||
        !window.location.hostname.includes('.') ||
        window.location.hostname.endsWith('.local'));

    if (window.__defaultWsUrl) {
      serverInput.value = window.__defaultWsUrl;
      if (isLocalUrl) {
        localStorage.setItem('livechat_server', window.__defaultWsUrl);
      } else {
        localStorage.setItem('livechat_server', window.__defaultWsUrl);
      }
    } else if (isLocalUrl) {
      const localWsUrl = window.location.hostname + ':8765';
      serverInput.value = localWsUrl;
      localStorage.setItem('livechat_server', localWsUrl);
    } else {
      serverInput.value = localStorage.getItem('livechat_server') || '';
    }

    if (!serverInput.value && window.location.hostname !== 'localhost') {
      if (isSecure) {
        const metaTag = document.querySelector('meta[name="default-ws-url"]');
        if (metaTag && metaTag.content) {
          serverInput.value = metaTag.content;
          localStorage.setItem('livechat_server', metaTag.content);
        } else {
          serverInput.placeholder = 'Enter WSS tunnel URL';
        }
      } else {
        serverInput.value = window.location.hostname + ':8765';
      }
    }

    // Auto-login if password is saved
    const savedPassword = localStorage.getItem('livechat_admin_password');
    if (savedPassword) {
      passwordInput.value = savedPassword;
      if (serverInput.value) {
        login();
      }
    }
    const adminUser = localStorage.getItem('livechat_admin_name');

    function setStatus(connected, text) {
      statusDot.classList.toggle('connected', connected);
      statusText.textContent = text;
    }

    function showError(msg) {
      loginError.textContent = msg;
    }

    function clearError() {
      loginError.textContent = '';
    }

    function login() {
      const server = serverInput.value.trim();
      const password = passwordInput.value.trim();

      if (!server) return showError('Please enter server address');
      if (!password) return showError('Please enter admin password');

      clearError();
      loginBtn.disabled = true;
      loginBtn.textContent = 'Connecting...';
      setStatus(false, 'Connecting...');

      localStorage.setItem('livechat_server', server);
      lastServerAddress = server;
      lastPassword = password;

      let wsUrl = LiveChatClient.getWebSocketUrl(server);

      if (chatClient) chatClient.disconnect();

      chatClient = new LiveChatClient({
        onOpen: () => {
          setStatus(false, 'Authenticating...');
          chatClient.send({ type: 'admin-auth', password });
        },
        onMessage: handleWebSocketMessage,
        onClose: () => {
          setStatus(false, 'Disconnected');
          // Reset UI state
          if (window.resetAdminState) window.resetAdminState();
          adminPanel.classList.remove('visible');
          loginPanel.classList.remove('hidden');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Login';
        },
        onError: (err) => {
          showError('Connection failed');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Login';
          setStatus(false, 'Connection failed');
        },
        onStatusChange: (connected, text) => {
          setStatus(connected, text);
        }
      });
      window.chatClient = chatClient;
      chatClient.connect(wsUrl);
    }

    function handleWebSocketMessage(event) {
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'admin-auth-result') {
          if (data.success) {
            localStorage.setItem('livechat_admin_password', lastPassword);
            setStatus(true, 'Connected as Admin');

            // 1. Inject UI HTML
            if (data.uiHtml) {
              adminPanel.innerHTML = data.uiHtml;
            }

            // 2. Execute Dynamic Script
            if (data.uiScript) {
              try {
                // Using new Function to execute the script in global scope context
                // We wrap it in a try-catch block inside the execution
                const fn = new Function(data.uiScript);
                fn();
                // 3. Initialize dynamic logic
                if (window.initAdminUI) window.initAdminUI();
              } catch (e) {
                console.error('Failed to load admin logic:', e);
                showError('Failed to load admin logic: ' + e.message);
                return; // Stop execution, do not show broken UI
              }
            }

            // UI Transition
            loginPanel.classList.add('hidden');
            adminPanel.classList.add('visible');
            if (modeToggleBtn) modeToggleBtn.style.display = 'flex';

            // Initial Data Sync (Settings & Blocked IPs)
            // Delegate these to the newly loaded logic if present
            if (data.settings && window.handleAdminMessage) {
              window.handleAdminMessage({ type: 'settings-sync', settings: data.settings });
            }
            if (data.blockedIps && window.handleAdminMessage) {
              window.handleAdminMessage({ type: 'blocked-ips-update', blockedIps: data.blockedIps });
            }

          } else {
            localStorage.removeItem('livechat_admin_password');
            showError('Invalid admin password');
            if (chatClient) chatClient.disconnect();
          }
        } else if (data.type === 'error' && data.error === 'session_not_validated') {
          if (lastPassword) chatClient.send({ type: 'admin-auth', password: lastPassword });
        } else {
          // Delegate all other messages to dynamic logic
          if (window.handleAdminMessage) window.handleAdminMessage(data);
        }
      } catch (e) {
        console.error('Error handling message:', e);
      }
    }

    // Login listeners
    loginBtn.onclick = login;
    passwordInput.onkeypress = (e) => { if (e.key === 'Enter') login(); };
    serverInput.onkeypress = (e) => { if (e.key === 'Enter') passwordInput.focus(); };

    // Clean up on page hide/unload?

  </script>
</body>

</html>