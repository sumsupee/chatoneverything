<!DOCTYPE html>
<html>
<head>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600&display=swap');

    :root {
      --bg: rgba(15, 15, 25, 0.85);
      --accent: #00d4aa;
      --accent2: #7c3aed;
      --text: #f0f0f5;
      --text-dim: #a0a0b0;
      --border: rgba(255, 255, 255, 0.08);
      --danger: #ff4757;
    }

    * { box-sizing: border-box; user-select: none; }

    /* Dark mode select dropdown */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0b0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px !important;
    }
    select option {
      background: #1a1a2e;
      color: #f0f0f5;
      padding: 10px;
    }
    select option:hover, select option:focus {
      background: #2a2a4e;
    }

    html, body {
      margin: 0; padding: 0; height: 100%;
      overflow: hidden; background: transparent;
      font-family: 'Outfit', sans-serif;
    }

    #app {
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      background: transparent;
      border-radius: 12px;
      border: none;
      overflow: hidden;
    }

    #app.active {
      background: var(--bg);
      border: 2px solid rgba(0, 212, 170, 0.6);
    }

    /* Drag bar */
    #drag-bar {
      display: none;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(0, 212, 170, 0.2), rgba(0, 212, 170, 0.05));
      border-bottom: 1px solid rgba(0, 212, 170, 0.6);
      font: 11px 'JetBrains Mono', monospace;
      color: var(--accent);
      cursor: grab;
      align-items: center;
      justify-content: space-between;
    }
    #drag-bar:active { cursor: grabbing; }
    #app.active #drag-bar { display: flex; }

    .grip { display: flex; gap: 3px; }
    .grip span { width: 5px; height: 5px; background: var(--accent); border-radius: 50%; }

    .bar-btn {
      border: none; color: white;
      padding: 6px 12px; border-radius: 6px; cursor: pointer;
      font: 500 12px 'Outfit', sans-serif;
    }
    #closeBtn { background: var(--danger); }
    #closeBtn:hover { background: #ff6b7a; }
    #settingsBtn, #passiveBtn { background: rgba(255,255,255,0.15); }
    #settingsBtn:hover, #passiveBtn:hover { background: rgba(255,255,255,0.25); }

    /* Messages */
    #messages {
      flex: 1; overflow-y: auto; padding: 8px 8px 4px 8px;
      display: flex; flex-direction: column;
      justify-content: flex-end; gap: 4px;
      align-items: flex-start;
    }
    #messages::-webkit-scrollbar { width: 5px; }
    #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    .msg {
      background: rgba(15, 15, 25, 0.9);
      backdrop-filter: blur(10px);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px; line-height: 1.3;
      border: 1px solid var(--border);
      animation: slideUp 0.3s ease;
      position: relative;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.35);
      width: fit-content;
      max-width: 90%;
      transition: opacity 0.3s ease;
    }
    .msg::before {
      content: ''; position: absolute;
      top: 0; left: 0; width: 3px; height: 100%;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      border-radius: 3px 0 0 3px;
    }

    .msg .del {
      display: none; position: absolute;
      top: 4px; right: 4px;
      width: 18px; height: 18px;
      background: var(--danger); border: none;
      border-radius: 4px; cursor: pointer;
      color: white; font-size: 10px;
      line-height: 18px; text-align: center;
    }
    #app.active .msg:hover .del { display: block; }

    .msg .user {
      color: var(--accent); font-weight: 600;
      font: 600 11px 'JetBrains Mono', monospace;
      display: inline;
      margin-right: 6px;
    }
    
    .msg .text { display: inline; }

    .msg img {
      max-width: 120px; display: block;
      margin-top: 8px; border-radius: 6px;
      border: 1px solid var(--border);
    }

    /* Resize edges - invisible but functional */
    .resize-edge {
      display: none; position: absolute;
      background: transparent;
      z-index: 100;
    }
    #app.active .resize-edge { display: block; }
    
    .resize-edge.top { top: 0; left: 10px; right: 10px; height: 8px; cursor: n-resize; }
    .resize-edge.bottom { bottom: 0; left: 10px; right: 10px; height: 8px; cursor: s-resize; }
    .resize-edge.left { left: 0; top: 10px; bottom: 10px; width: 8px; cursor: w-resize; }
    .resize-edge.right { right: 0; top: 10px; bottom: 10px; width: 8px; cursor: e-resize; }
    
    .resize-edge.top-left { top: 0; left: 0; width: 14px; height: 14px; cursor: nw-resize; }
    .resize-edge.top-right { top: 0; right: 0; width: 14px; height: 14px; cursor: ne-resize; }
    .resize-edge.bottom-left { bottom: 0; left: 0; width: 14px; height: 14px; cursor: sw-resize; }
    .resize-edge.bottom-right { bottom: 0; right: 0; width: 14px; height: 14px; cursor: se-resize; }


    /* Join text */
    #join-text {
      padding: 0 8px 8px 8px;
      font: 500 11px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      display: none;
    }
    #join-text.visible { display: block; }
    #join-text span { color: var(--accent); }

    /* QR Code display */
    #qr-overlay {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      z-index: 50;
      padding: 20px;
      text-align: center;
    }
    #qr-overlay.visible { display: flex; }
    
    #qr-overlay .qr-main-title {
      font: 600 16px 'Outfit', sans-serif;
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
    }
    
    #qr-overlay img {
      width: 140px;
      height: 140px;
      border-radius: 10px;
      background: white;
      padding: 8px;
      margin-bottom: 12px;
      box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
    }
    
    #qr-overlay .qr-title {
      font: 600 12px 'JetBrains Mono', monospace;
      color: var(--accent);
      margin-bottom: 6px;
    }
    
    #qr-overlay .qr-url {
      font: 10px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      word-break: break-all;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border: 1px solid var(--border);
      max-width: 90%;
    }
    
    #qr-overlay .qr-back-btn {
      margin-top: 16px;
      padding: 8px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font: 500 12px 'Outfit', sans-serif;
      cursor: pointer;
    }
    #qr-overlay .qr-back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Mode indicator */
    #mode {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(15, 15, 25, 0.9);
      backdrop-filter: blur(10px);
      padding: 5px 10px; border-radius: 6px;
      font: 10px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    #mode.show { opacity: 1; }

    /* Settings panel */
    #settings {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 25, 0.98);
      backdrop-filter: blur(16px);
      padding: 0;
      border-radius: 14px;
      border: 1px solid rgba(0, 212, 170, 0.3);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
      z-index: 200;
      min-width: 280px;
      max-width: 340px;
      max-height: 90vh;
      overflow: hidden;
    }
    /* Actual scroll container (native scrollbar fully hidden) */
    #settings-scroll {
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px 24px;
      scrollbar-width: none; /* Firefox */
    }
    #settings-scroll::-webkit-scrollbar { width: 0; height: 0; } /* Chromium/Electron */

    /* Custom thumb-only scrollbar (no buttons) */
    #settings-scrollbar {
      position: absolute;
      top: 14px;
      right: 8px;
      bottom: 14px;
      width: 6px;
      background: transparent;
      pointer-events: none; /* thumb enables interaction */
    }
    #settings-scroll-thumb {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 24px;
      border-radius: 999px;
      background: rgba(0, 170, 136, 0.95);
      opacity: 0.9;
      pointer-events: auto;
      cursor: pointer;
    }
    #settings-scroll-thumb:hover {
      opacity: 1;
      background: rgba(0, 196, 158, 1);
    }
    #settings.open { display: block; }

    #settings h3 {
      margin: 0 0 16px 0;
      font: 600 14px 'JetBrains Mono', monospace;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #settings .close-settings {
      background: none; border: none;
      color: var(--text-dim); cursor: pointer;
      font-size: 16px; padding: 0;
    }
    #settings .close-settings:hover { color: var(--text); }

    #settings label {
      font: 11px 'JetBrains Mono', monospace;
      color: var(--text-dim);
      display: block;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #settings .setting-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #settings input[type="range"] {
      flex: 1;
      accent-color: var(--accent);
      height: 6px;
    }

    #settings .value {
      font: 600 16px 'JetBrains Mono', monospace;
      color: var(--accent);
      min-width: 28px;
      text-align: center;
    }
    #settings .settings-link {
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
      user-select: text;
    }
    #settings .settings-link:hover {
      text-decoration: none;
      opacity: 0.95;
    }

    /* Admin password show/hide (settings) */
    #settings .password-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0 12px 0;
    }
    #settings .password-input-wrap {
      position: relative;
      flex: 1;
      min-width: 0;
      pointer-events: auto;
    }
    #settings #admin-password {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      font: 600 11px 'JetBrains Mono', monospace;
      color: var(--accent);
      outline: none;
      user-select: none; /* selectable only when visible */
      -webkit-user-select: none;
      padding-right: 34px; /* space for copy icon */
    }
    #settings #admin-password.visible {
      user-select: text;
      -webkit-user-select: text;
    }
    #settings #admin-password-copy {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.20);
      color: rgba(255, 255, 255, 0.88);
      display: none; /* only shown when password visible */
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 14px;
      z-index: 2;
    }
    #settings #admin-password-copy:hover {
      border-color: rgba(255, 255, 255, 0.18);
      color: rgba(255, 255, 255, 0.85);
    }
    #settings #admin-password-copy:active {
      transform: translateY(-50%) scale(0.98);
    }
    #settings #admin-password-copy.show {
      display: inline-flex;
    }
    #settings #admin-password-toggle,
    #settings #admin-password-copy-btn {
      flex: 0 0 auto;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.10);
      color: var(--text);
      font: 600 11px 'JetBrains Mono', monospace;
      cursor: pointer;
    }
    #settings #admin-password-toggle:hover,
    #settings #admin-password-copy-btn:hover {
      background: rgba(255, 255, 255, 0.16);
    }

    /* API key input styling */
    #settings #cee-api-key {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      font: 600 11px 'JetBrains Mono', monospace;
      color: var(--accent);
      outline: none;
      user-select: text !important;
      -webkit-user-select: text !important;
      -webkit-user-modify: read-write-plaintext-only;
      pointer-events: auto !important;
      padding-right: 34px;
      cursor: text;
    }
    #settings #cee-api-key:focus {
      border-color: rgba(0, 212, 170, 0.5);
      background: rgba(255, 255, 255, 0.08);
    }
    #settings #cee-api-key::placeholder {
      color: var(--text-dim);
      font-weight: 400;
    }
    #settings #cee-api-key-copy {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.20);
      color: rgba(255, 255, 255, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 14px;
      z-index: 2;
    }
    #settings #cee-api-key-copy:hover {
      border-color: rgba(255, 255, 255, 0.18);
      color: rgba(255, 255, 255, 0.85);
    }
    #settings #cee-api-key-copy.show {
      display: inline-flex;
    }
    #settings #cee-api-key-toggle {
      flex: 0 0 auto;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.10);
      color: var(--text);
      font: 600 11px 'JetBrains Mono', monospace;
      cursor: pointer;
    }
    /* Custom instructions textarea styling */
    #settings #ceeSystemPrompt {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      font: 13px 'Outfit', sans-serif;
      color: var(--text);
      outline: none;
      resize: vertical;
      min-height: 50px;
      max-height: 120px;
      scrollbar-width: none; /* Firefox - hide native scrollbar */
    }
    #settings #ceeSystemPrompt:focus {
      border-color: rgba(255, 255, 255, 0.28);
      background: rgba(255, 255, 255, 0.08);
    }
    #settings #ceeSystemPrompt::placeholder {
      color: var(--text-dim);
    }
    /* Hide native scrollbar completely - same as settings panel */
    #settings #ceeSystemPrompt::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;
    }
    #settings #cee-api-key-toggle:hover {
      background: rgba(255, 255, 255, 0.16);
    }

    /* Settings backdrop */
    #settings-backdrop, #confirm-backdrop {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 150;
      /* Ensure the dimming layer respects the overlay rounded corners */
      border-radius: 12px;
      clip-path: inset(0 round 12px);
    }
    #settings-backdrop.open, #confirm-backdrop.open { display: block; }

    /* Confirm dialog */
    #confirm-dialog {
      display: none;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 15, 25, 0.98);
      backdrop-filter: blur(16px);
      padding: 20px 24px;
      border-radius: 14px;
      border: 1px solid rgba(255, 71, 87, 0.4);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
      z-index: 200;
      text-align: center;
      min-width: 260px;
    }
    #confirm-dialog.open { display: block; }

    #confirm-dialog p {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    #confirm-dialog .btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    #confirm-dialog button {
      padding: 8px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font: 500 13px 'Outfit', sans-serif;
    }

    #confirm-dialog .cancel-btn {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    #confirm-dialog .cancel-btn:hover { background: rgba(255,255,255,0.2); }

    #confirm-dialog .confirm-btn {
      background: var(--danger);
      color: white;
    }
    #confirm-dialog .confirm-btn:hover { background: #ff6b7a; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="drag-bar" title="Drag to Move">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="grip"><span></span><span></span><span></span></div>
        <span title="Drag to Move">Chat on Everything</span>
      </div>
      <div style="display:flex;gap:8px">
        <button id="passiveBtn" class="bar-btn" title="Immersive Mode Ctrl+Shift+O/F9">üëÅ</button>
        <button id="settingsBtn" class="bar-btn" title="Settings">‚öô</button>
        <button id="closeBtn" class="bar-btn" title="End Session">‚úï</button>
      </div>
    </div>

    <div id="messages"></div>
    <div id="join-text">Join Chat on Everything: <span id="session-code">ABC123</span></div>
    
    <!-- QR Code Overlay -->
    <div id="qr-overlay">
      <div class="qr-main-title">Chat on Everything</div>
      <img id="qr-image" src="" alt="QR Code">
      <div class="qr-title">Scan to Join</div>
      <div class="qr-url" id="qr-url"></div>
      <button class="qr-back-btn" id="qr-back-btn">Continue</button>
    </div>
    
    <!-- Resize edges -->
    <div class="resize-edge top" data-dir="n"></div>
    <div class="resize-edge bottom" data-dir="s"></div>
    <div class="resize-edge left" data-dir="w"></div>
    <div class="resize-edge right" data-dir="e"></div>
    <div class="resize-edge top-left" data-dir="nw"></div>
    <div class="resize-edge top-right" data-dir="ne"></div>
    <div class="resize-edge bottom-left" data-dir="sw"></div>
    <div class="resize-edge bottom-right" data-dir="se"></div>
    
    <div id="settings-backdrop"></div>
    <div id="settings">
      <div id="settings-scroll">
        <h3>
          Settings
          <button class="close-settings">‚úï</button>
        </h3>
        
        <!-- Session Info Section -->
        <div style="font:500 12px 'Outfit',sans-serif;color:var(--accent);margin:4px 0 12px 0;">
      Session Details
        </div>
        <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
          <label>Mobile URL</label>
          <a style="font:500 11px 'JetBrains Mono',monospace;margin:4px 0 12px 0;word-break:break-all;display:block" class="settings-link" id="mobile-url" href="#">Loading...</a>
          
          <label>Admin URL</label>
          <a style="font:500 11px 'JetBrains Mono',monospace;margin:4px 0 12px 0;word-break:break-all;display:block" class="settings-link" id="admin-url" href="#">Loading...</a>
          
          <label>Admin Password</label>
          <div class="password-row">
            <div class="password-input-wrap">
              <input id="admin-password" type="password" value="--------" readonly aria-label="Admin password">
              <button id="admin-password-copy" type="button" aria-label="Copy admin password" title="Copy">üìã</button>
            </div>
            <button id="admin-password-toggle" type="button" aria-label="Show admin password">Show</button>
          </div>

          <label>Hotkey</label>
          <div style="font:600 11px 'JetBrains Mono',monospace;color:var(--accent);margin:4px 0 12px 0" id="hotkey-value">Ctrl+Shift+O/F9</div>
          <label>Support</label>
          <div style="font:600 11px 'JetBrains Mono',monospace;color:var(--accent);margin:4px 0 12px 0" id="support-value">Sumedh Supe</div>
        </div>
        
        <!-- Display Settings -->
        <label style="margin-top:0">
          <input type="checkbox" id="hideIp" style="margin-right:8px;accent-color:var(--accent)">
          Hide IP
        </label>
        
        <label style="margin-top:16px">Max Messages</label>
        <div class="setting-row">
          <input type="range" id="maxMsgSlider" min="2" max="10" value="5">
          <span class="value" id="maxMsgValue">5</span>
        </div>
        
        <label style="margin-top:16px">Font Size</label>
        <div class="setting-row">
        <input type="range" id="fontSizeSlider" min="10" max="48" value="13">
          <span class="value" id="fontSizeValue">13</span>
        </div>
        
        <label style="margin-top:16px">
          <input type="checkbox" id="showJoinCode" style="margin-right:8px;accent-color:var(--accent)">
          Show Join Code
        </label>
        
        <label style="margin-top:12px">
          <input type="checkbox" id="showMobileLink" style="margin-right:8px;accent-color:var(--accent)">
          Show QR Code
        </label>
        
        <label style="margin-top:12px">
          <input type="checkbox" id="disableChatHistory" checked style="margin-right:8px;accent-color:var(--accent)">
          Disable Chat History for Others
        </label>

        <label style="margin-top:12px">
          <input type="checkbox" id="enableFeedbackForm" style="margin-right:8px;accent-color:var(--accent)">
          Enable Feedback Form
        </label>

        <label style="margin-top:12px">
          <input type="checkbox" id="emojiDirectSend" checked style="margin-right:8px;accent-color:var(--accent)">
          Emoji Direct to Send
        </label>

        <label style="margin-top:12px">
          <input type="checkbox" id="slowModeEnabled" style="margin-right:8px;accent-color:var(--accent)">
          Slow Mode
        </label>

        <div id="slowModeSecondsGroup" style="margin-top:12px;display:none">
          <label>Slow Mode Delay (seconds)</label>
          <div class="setting-row">
            <input type="range" id="slowModeSlider" min="1" max="30" value="3">
            <span class="value" id="slowModeValue">3</span>
          </div>
        </div>

        <!-- @Cee AI Agent Settings -->
        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
          <div style="font:500 12px 'Outfit',sans-serif;color:var(--accent);margin:4px 0 12px 0;">
            @Cee AI Agent
          </div>
          <label style="margin-top:0">
            <input type="checkbox" id="enableCeeAgent" style="margin-right:8px;accent-color:var(--accent)">
            Enable @Cee Agent
          </label>
          
          <div id="ceeApiKeyGroup" style="margin-top:12px;display:none">
            <label>API Provider</label>
            <select id="ceeApiProvider" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#1a1a2e;color:var(--text);font:500 13px 'Outfit',sans-serif;outline:none;margin-bottom:12px;cursor:pointer">
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini</option>
            </select>
            <label id="ceeApiKeyLabel">OpenAI API Key</label>
            <div class="password-row">
              <div class="password-input-wrap">
                <input id="cee-api-key" type="password" value="" placeholder="sk-..." aria-label="API Key" tabindex="0">
                <button id="cee-api-key-copy" type="button" aria-label="Copy API key" title="Copy">üìã</button>
              </div>
              <button id="cee-api-key-toggle" type="button" aria-label="Show API key">Show</button>
            </div>
            <div id="ceeApiKeyStatus" style="font:600 11px 'JetBrains Mono',monospace;color:var(--danger);margin:4px 0 8px 0;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border)">
              Not Set
            </div>
            <label style="margin-top:12px">Custom Instructions (optional)</label>
            <textarea id="ceeSystemPrompt" rows="2" maxlength="300" placeholder="e.g., be like Darth Vader, answer in 10 words only, talk like Yoda..."></textarea>
            <div style="font:11px 'Outfit',sans-serif;color:var(--text-dim);margin-top:4px">Customize Cee's personality or response style</div>
          </div>
        </div>
      </div>
      <div id="settings-scrollbar" aria-hidden="true">
        <div id="settings-scroll-thumb"></div>
      </div>
    </div>

    <div id="confirm-backdrop"></div>
    <div id="confirm-dialog">
      <p>Are you sure you want to<br>end the session?</p>
      <div class="btn-row">
        <button class="cancel-btn">Cancel</button>
        <button class="confirm-btn">End Session</button>
      </div>
    </div>
    
    <div id="mode">ACTIVE</div>
  </div>

  <script>
    const { ipcRenderer, shell, clipboard } = require('electron');

    const $ = id => document.getElementById(id);
    const app = $('app'), dragBar = $('drag-bar');
    const messages = $('messages'), mode = $('mode');

    let dragging = false, resizing = false, resizeDir = '';
    let lastX = 0, lastY = 0;
    let startX = 0, startY = 0, startW = 0, startH = 0, startPosX = 0, startPosY = 0;

    // Drag
    dragBar.onmousedown = e => {
      if (e.target.id === 'closeBtn') return;
      dragging = true;
      lastX = e.screenX; lastY = e.screenY;
    };

    // Resize from any edge
    document.querySelectorAll('.resize-edge').forEach(edge => {
      edge.onmousedown = async e => {
        resizing = true;
        resizeDir = edge.dataset.dir;
        const b = await ipcRenderer.invoke('get-window-bounds');
        startX = e.screenX; startY = e.screenY;
        startW = b.width; startH = b.height;
        startPosX = b.x; startPosY = b.y;
        e.preventDefault();
      };
    });

    document.onmousemove = e => {
      if (dragging) {
        ipcRenderer.send('window-move', { deltaX: e.screenX - lastX, deltaY: e.screenY - lastY });
        lastX = e.screenX; lastY = e.screenY;
      }
      if (resizing) {
        const dx = e.screenX - startX;
        const dy = e.screenY - startY;
        let x, y, w = startW, h = startH;

        // Handle each direction
        if (resizeDir.includes('e')) w = startW + dx;
        if (resizeDir.includes('w')) { w = startW - dx; x = startPosX + dx; }
        if (resizeDir.includes('s')) h = startH + dy;
        if (resizeDir.includes('n')) { h = startH - dy; y = startPosY + dy; }

        ipcRenderer.send('window-resize', { width: w, height: h, x, y });
      }
    };

    document.onmouseup = () => { dragging = false; resizing = false; resizeDir = ''; };

    // Mode toggle
    ipcRenderer.on('mode-change', (_, m) => {
      mode.textContent = m.toUpperCase();
      mode.classList.add('show');
      app.classList.toggle('active', m === 'active');
      if (m === 'passive') {
        closeSettings();
        setTimeout(() => mode.classList.remove('show'), 2000);
      }
    });

    // Enter passive mode
    $('passiveBtn').onclick = () => ipcRenderer.send('enter-passive');

    // Close app with confirmation
    const confirmDialog = $('confirm-dialog');
    const confirmBackdrop = $('confirm-backdrop');

    function showConfirm() {
      confirmDialog.classList.add('open');
      confirmBackdrop.classList.add('open');
    }

    function hideConfirm() {
      confirmDialog.classList.remove('open');
      confirmBackdrop.classList.remove('open');
    }

    $('closeBtn').onclick = showConfirm;
    confirmBackdrop.onclick = hideConfirm;
    confirmDialog.querySelector('.cancel-btn').onclick = hideConfirm;
    confirmDialog.querySelector('.confirm-btn').onclick = () => ipcRenderer.send('close-app');

    // Settings menu
    const settings = $('settings');
    const settingsBackdrop = $('settings-backdrop');
    const settingsScroll = $('settings-scroll');
    const settingsScrollBar = $('settings-scrollbar');
    const settingsScrollThumb = $('settings-scroll-thumb');
    let settingsThumbDrag = null;

    function updateSettingsThumb() {
      if (!settingsScroll || !settingsScrollBar || !settingsScrollThumb) return;
      const ch = settingsScroll.clientHeight;
      const sh = settingsScroll.scrollHeight;
      const trackH = settingsScrollBar.clientHeight;

      // If hidden/not laid out yet, bail.
      if (ch <= 0 || sh <= 0 || trackH <= 0) return;

      // No scrolling needed -> hide custom thumb.
      if (sh <= ch + 1) {
        settingsScrollBar.style.display = 'none';
        return;
      }

      settingsScrollBar.style.display = 'block';

      // Make the thumb intentionally shorter (UX preference), but keep it usable.
      const thumbScale = 0.75;
      const minThumb = 18;
      const idealThumb = Math.round(trackH * (ch / sh) * thumbScale);
      const thumbH = Math.max(minThumb, idealThumb);
      const maxTop = Math.max(0, trackH - thumbH);
      const maxScroll = Math.max(1, sh - ch);
      const rawTop = (settingsScroll.scrollTop / maxScroll) * maxTop;
      const top = Math.min(maxTop, Math.max(0, rawTop));

      settingsScrollThumb.style.height = `${thumbH}px`;
      settingsScrollThumb.style.transform = `translateY(${top}px)`;
    }
    
    function openSettings() {
      settings.classList.add('open');
      settingsBackdrop.classList.add('open');
      // Let layout happen before calculating scroll metrics.
      requestAnimationFrame(() => requestAnimationFrame(updateSettingsThumb));
    }
    
    function closeSettings() {
      settings.classList.remove('open');
      settingsBackdrop.classList.remove('open');
    }

    $('settingsBtn').onclick = openSettings;
    settings.querySelector('.close-settings').onclick = closeSettings;
    settingsBackdrop.onclick = closeSettings;

    // Custom scrollbar wiring (thumb-only)
    if (settingsScroll) {
      settingsScroll.addEventListener('scroll', updateSettingsThumb, { passive: true });
    }

    if (settingsScrollThumb && settingsScroll) {
      settingsScrollThumb.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const ch = settingsScroll.clientHeight;
        const sh = settingsScroll.scrollHeight;
        const thumbH = settingsScrollThumb.getBoundingClientRect().height;
        const trackH = settingsScrollBar ? settingsScrollBar.clientHeight : ch;
        const maxTop = Math.max(1, trackH - thumbH);
        const maxScroll = Math.max(1, sh - ch);

        settingsThumbDrag = {
          startY: e.clientY,
          startScrollTop: settingsScroll.scrollTop,
          pxToScroll: maxScroll / maxTop,
        };
      });
    }

    document.addEventListener('mousemove', (e) => {
      if (!settingsThumbDrag || !settingsScroll) return;
      const dy = e.clientY - settingsThumbDrag.startY;
      settingsScroll.scrollTop = settingsThumbDrag.startScrollTop + (dy * settingsThumbDrag.pxToScroll);
    });

    document.addEventListener('mouseup', () => { settingsThumbDrag = null; });

    // Keep thumb correct if content/size changes.
    if (window.ResizeObserver && settingsScroll) {
      const ro = new ResizeObserver(() => updateSettingsThumb());
      ro.observe(settingsScroll);
    } else {
      window.addEventListener('resize', updateSettingsThumb);
    }

    // Settings
    let maxMessages = 5;
    const maxMsgSlider = $('maxMsgSlider');
    const maxMsgValue = $('maxMsgValue');

    maxMsgSlider.oninput = () => {
      maxMessages = parseInt(maxMsgSlider.value);
      maxMsgValue.textContent = maxMessages;
      trimMessages();
      updateOpacity();
      ipcRenderer.send('settings-changed', { maxMessages });
    };

    // Font size setting
    const fontSizeSlider = $('fontSizeSlider');
    const fontSizeValue = $('fontSizeValue');

    function applyFontSize(size) {
      document.querySelectorAll('.msg').forEach(msg => {
        msg.style.fontSize = size + 'px';
        msg.querySelector('.user').style.fontSize = (size - 2) + 'px';
      });
      messages.dataset.fontSize = size;
    }

    fontSizeSlider.oninput = () => {
      const size = parseInt(fontSizeSlider.value);
      fontSizeValue.textContent = size;
      applyFontSize(size);
      ipcRenderer.send('settings-changed', { fontSize: size });
    };

    // Join code visibility
    const joinText = $('join-text');
    const showJoinCodeCheckbox = $('showJoinCode');
    let showJoinCode = false; // Default to hidden

    function updateJoinTextVisibility() {
      const hasMessages = messages.children.length > 0;
      if (showJoinCode && hasMessages) {
        joinText.classList.add('visible');
      } else {
        joinText.classList.remove('visible');
      }
    }

    showJoinCodeCheckbox.onchange = () => {
      showJoinCode = showJoinCodeCheckbox.checked;
      updateJoinTextVisibility();
      ipcRenderer.send('settings-changed', { showJoinCode });
    };

    // Show QR Code setting
    const showMobileLinkCheckbox = $('showMobileLink');
    const qrOverlay = $('qr-overlay');
    const qrImage = $('qr-image');
    const qrUrlEl = $('qr-url');
    let mobileUrl = '';
    
    function updateQRDisplay(show) {
      if (show && mobileUrl) {
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(mobileUrl)}`;
        qrImage.src = qrApiUrl;
        qrUrlEl.textContent = mobileUrl;
        qrOverlay.classList.add('visible');
      } else {
        qrOverlay.classList.remove('visible');
      }
    }
    
    showMobileLinkCheckbox.onchange = () => {
      updateQRDisplay(showMobileLinkCheckbox.checked);
      ipcRenderer.send('settings-changed', { showMobileLink: showMobileLinkCheckbox.checked });
    };
    
    // QR back button
    $('qr-back-btn').onclick = () => {
      showMobileLinkCheckbox.checked = false;
      updateQRDisplay(false);
      ipcRenderer.send('settings-changed', { showMobileLink: false });
    };

    // Hide IP setting
    const hideIpCheckbox = $('hideIp');
    if (hideIpCheckbox) {
      hideIpCheckbox.onchange = () => {
        ipcRenderer.send('settings-changed', { hideIp: hideIpCheckbox.checked });
        // Refresh session info to get updated URLs
        initSession().then(() => {
          // Update QR code if it's currently displayed
          if (showMobileLinkCheckbox && showMobileLinkCheckbox.checked) {
            updateQRDisplay(true);
          }
        });
      };
    }

    // Disable chat history setting
    const disableChatHistoryCheckbox = $('disableChatHistory');
    
    disableChatHistoryCheckbox.onchange = () => {
      ipcRenderer.send('settings-changed', { disableChatHistory: disableChatHistoryCheckbox.checked });
    };

    // Feedback form setting (mobile-only)
    const enableFeedbackFormCheckbox = $('enableFeedbackForm');
    if (enableFeedbackFormCheckbox) {
      enableFeedbackFormCheckbox.onchange = () => {
        ipcRenderer.send('settings-changed', { enableFeedbackForm: enableFeedbackFormCheckbox.checked });
      };
    }

    // Emoji direct send setting
    const emojiDirectSendCheckbox = $('emojiDirectSend');
    if (emojiDirectSendCheckbox) {
      emojiDirectSendCheckbox.onchange = () => {
        ipcRenderer.send('settings-changed', { emojiDirectSend: emojiDirectSendCheckbox.checked });
      };
    }

    // Slow mode settings
    const slowModeEnabledCheckbox = $('slowModeEnabled');
    const slowModeSlider = $('slowModeSlider');
    const slowModeValueEl = $('slowModeValue');
    const slowModeSecondsGroup = $('slowModeSecondsGroup');

    function updateSlowModeVisibility() {
      if (slowModeSecondsGroup) {
        slowModeSecondsGroup.style.display = slowModeEnabledCheckbox && slowModeEnabledCheckbox.checked ? 'block' : 'none';
      }
    }

    if (slowModeEnabledCheckbox) {
      slowModeEnabledCheckbox.onchange = () => {
        updateSlowModeVisibility();
        ipcRenderer.send('settings-changed', { slowModeEnabled: slowModeEnabledCheckbox.checked });
      };
    }

    if (slowModeSlider) {
      slowModeSlider.oninput = () => {
        const val = parseInt(slowModeSlider.value, 10) || 3;
        if (slowModeValueEl) slowModeValueEl.textContent = val;
        ipcRenderer.send('settings-changed', { slowModeSeconds: val });
      };
    }

    // @Cee Agent settings
    const enableCeeAgentCheckbox = $('enableCeeAgent');
    const ceeApiKeyGroup = $('ceeApiKeyGroup');
    const ceeApiKeyStatus = $('ceeApiKeyStatus');
    const ceeApiProviderSelect = $('ceeApiProvider');
    const ceeApiKeyLabel = $('ceeApiKeyLabel');

    function updateCeeApiKeyVisibility() {
      if (ceeApiKeyGroup) {
        ceeApiKeyGroup.style.display = enableCeeAgentCheckbox && enableCeeAgentCheckbox.checked ? 'block' : 'none';
      }
    }

    function updateCeeApiKeyStatus(isSet) {
      if (ceeApiKeyStatus) {
        if (isSet) {
          ceeApiKeyStatus.textContent = 'API Key Set ‚úì';
          ceeApiKeyStatus.style.color = 'var(--accent)';
        } else {
          ceeApiKeyStatus.textContent = 'Not Set';
          ceeApiKeyStatus.style.color = 'var(--danger)';
        }
      }
    }

    function updateCeeApiProviderUI(provider) {
      const p = provider || 'openai';
      if (ceeApiKeyLabel) {
        ceeApiKeyLabel.textContent = p === 'gemini' ? 'Gemini API Key' : 'OpenAI API Key';
      }
      if (ceeApiKeyInput) {
        ceeApiKeyInput.placeholder = p === 'gemini' ? 'AIza...' : 'sk-...';
      }
      if (ceeApiProviderSelect) {
        ceeApiProviderSelect.value = p;
      }
    }

    // Provider dropdown handler
    if (ceeApiProviderSelect) {
      ceeApiProviderSelect.onchange = () => {
        const provider = ceeApiProviderSelect.value;
        updateCeeApiProviderUI(provider);
        // Clear the API key when switching providers
        if (ceeApiKeyInput) {
          ceeApiKeyInput.value = '';
          updateCeeApiKeyStatus(false);
        }
        ipcRenderer.send('settings-changed', { ceeApiProvider: provider, ceeApiKey: '' });
      };
    }

    // Persistent screen capture stream (for @Cee - avoids repeated permission dialogs)
    let screenStream = null;
    let screenVideo = null;
    let screenCanvas = null;

    async function initScreenCapture() {
      if (screenStream) {
        console.log('[Cee] Screen capture already initialized');
        return true;
      }

      try {
        // Get screen sources
        const sources = await ipcRenderer.invoke('get-screen-sources');
        if (!sources || sources.length === 0) {
          console.error('[Cee] No screen sources available');
          return false;
        }

        const sourceId = sources[0].id;
        console.log('[Cee] Requesting screen capture for source:', sourceId);

        // Request persistent stream - this shows permission dialog ONCE
        screenStream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: sourceId,
              maxWidth: 1920,
              maxHeight: 1080
            }
          }
        });

        // Create hidden video element to capture frames
        screenVideo = document.createElement('video');
        screenVideo.srcObject = screenStream;
        screenVideo.style.display = 'none';
        document.body.appendChild(screenVideo);
        await screenVideo.play();

        // Create canvas for frame capture
        screenCanvas = document.createElement('canvas');

        console.log('[Cee] Screen capture initialized successfully');
        return true;
      } catch (err) {
        console.error('[Cee] Failed to initialize screen capture:', err.message);
        return false;
      }
    }

    function stopScreenCapture() {
      if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
      }
      if (screenVideo) {
        screenVideo.remove();
        screenVideo = null;
      }
      screenCanvas = null;
      console.log('[Cee] Screen capture stopped');
    }

    async function captureScreenFrame() {
      if (!screenStream || !screenVideo || !screenCanvas) {
        console.log('[Cee] Screen capture not initialized, initializing...');
        const ok = await initScreenCapture();
        if (!ok) return null;
      }

      try {
        // Capture frame from video
        const width = screenVideo.videoWidth;
        const height = screenVideo.videoHeight;
        
        // Resize to max 512px width
        let targetWidth = width;
        let targetHeight = height;
        if (width > 512) {
          const scale = 512 / width;
          targetWidth = Math.round(width * scale);
          targetHeight = Math.round(height * scale);
        }

        screenCanvas.width = targetWidth;
        screenCanvas.height = targetHeight;
        const ctx = screenCanvas.getContext('2d');
        ctx.drawImage(screenVideo, 0, 0, targetWidth, targetHeight);

        // Convert to base64 JPEG
        const dataUrl = screenCanvas.toDataURL('image/jpeg', 0.8);
        const base64 = dataUrl.replace(/^data:image\/jpeg;base64,/, '');
        return base64;
      } catch (err) {
        console.error('[Cee] Failed to capture frame:', err.message);
        return null;
      }
    }

    // Handle screenshot request from main process
    ipcRenderer.on('capture-screenshot', async (event) => {
      const screenshot = await captureScreenFrame();
      ipcRenderer.send('screenshot-result', screenshot);
    });

    if (enableCeeAgentCheckbox) {
      enableCeeAgentCheckbox.onchange = async () => {
        updateCeeApiKeyVisibility();
        
        // Initialize or stop screen capture based on toggle
        if (enableCeeAgentCheckbox.checked) {
          const ok = await initScreenCapture();
          if (!ok) {
            // If screen capture fails, still allow enabling (will try again on first use)
            console.log('[Cee] Screen capture init failed, will retry on first use');
          }
        } else {
          stopScreenCapture();
        }
        
        ipcRenderer.send('settings-changed', { enableCeeAgent: enableCeeAgentCheckbox.checked });
      };
    }

    // API key input handling
    const ceeApiKeyInput = $('cee-api-key');
    const ceeApiKeyToggle = $('cee-api-key-toggle');
    const ceeApiKeyCopy = $('cee-api-key-copy');
    let ceeApiKeyVisible = false;

    function setCeeApiKeyVisible(visible) {
      ceeApiKeyVisible = !!visible;
      if (!ceeApiKeyInput || !ceeApiKeyToggle) return;
      ceeApiKeyInput.type = ceeApiKeyVisible ? 'text' : 'password';
      ceeApiKeyToggle.textContent = ceeApiKeyVisible ? 'Hide' : 'Show';
      ceeApiKeyToggle.setAttribute('aria-label', ceeApiKeyVisible ? 'Hide API key' : 'Show API key');
      if (ceeApiKeyCopy) ceeApiKeyCopy.classList.toggle('show', ceeApiKeyVisible && ceeApiKeyInput.value.length > 0);
    }

    if (ceeApiKeyToggle) {
      ceeApiKeyToggle.onclick = () => setCeeApiKeyVisible(!ceeApiKeyVisible);
    }

    // Save API key when input changes (debounced)
    let ceeApiKeySaveTimeout = null;
    if (ceeApiKeyInput) {
      ceeApiKeyInput.oninput = () => {
        // Update copy button visibility
        if (ceeApiKeyCopy) ceeApiKeyCopy.classList.toggle('show', ceeApiKeyVisible && ceeApiKeyInput.value.length > 0);
        
        // Debounce save (500ms after typing stops)
        if (ceeApiKeySaveTimeout) clearTimeout(ceeApiKeySaveTimeout);
        ceeApiKeySaveTimeout = setTimeout(() => {
          const key = ceeApiKeyInput.value.trim();
          ipcRenderer.send('settings-changed', { ceeApiKey: key });
          // Update status immediately based on input
          updateCeeApiKeyStatus(key.length > 0);
        }, 500);
      };

      // Also save on blur (in case user tabs away quickly)
      ceeApiKeyInput.onblur = () => {
        if (ceeApiKeySaveTimeout) {
          clearTimeout(ceeApiKeySaveTimeout);
          ceeApiKeySaveTimeout = null;
        }
        const key = ceeApiKeyInput.value.trim();
        ipcRenderer.send('settings-changed', { ceeApiKey: key });
        updateCeeApiKeyStatus(key.length > 0);
      };
    }

    async function copyCeeApiKey() {
      if (!ceeApiKeyVisible || !ceeApiKeyInput) return;
      const text = String(ceeApiKeyInput.value || '');
      if (!text) return;

      let ok = false;
      try {
        if (clipboard && clipboard.writeText) {
          clipboard.writeText(text);
          ok = true;
        }
      } catch (_) {}

      if (!ok) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            ok = true;
          }
        } catch (_) {}
      }

      if (ceeApiKeyCopy) {
        const prev = ceeApiKeyCopy.textContent;
        ceeApiKeyCopy.textContent = ok ? '‚úì' : '!';
        setTimeout(() => {
          if (ceeApiKeyCopy) ceeApiKeyCopy.textContent = prev || 'üìã';
        }, 700);
      }
    }

    if (ceeApiKeyCopy) {
      ceeApiKeyCopy.onclick = copyCeeApiKey;
    }

    // Explicitly handle focus for API key input (Electron quirk workaround)
    if (ceeApiKeyInput) {
      // Handle mousedown to focus before click event
      ceeApiKeyInput.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        // Request window focus from main process
        ipcRenderer.send('request-focus');
        // Small delay to ensure focus sticks
        setTimeout(() => ceeApiKeyInput.focus(), 10);
      });
      
      // Prevent focus loss when clicking inside the input
      ceeApiKeyInput.addEventListener('click', (e) => {
        e.stopPropagation();
        ceeApiKeyInput.focus();
      });
      
      // When input gets focus, ensure window is focused
      ceeApiKeyInput.addEventListener('focus', () => {
        ipcRenderer.send('request-focus');
      });
      
      // Prevent keyboard events from propagating to parent/document
      ceeApiKeyInput.addEventListener('keydown', (e) => {
        e.stopPropagation();
      });
      
      ceeApiKeyInput.addEventListener('keyup', (e) => {
        e.stopPropagation();
      });
      
      ceeApiKeyInput.addEventListener('keypress', (e) => {
        e.stopPropagation();
      });
    }
    setCeeApiKeyVisible(false);

    // Custom system prompt handling (debounced)
    const ceeSystemPromptInput = $('ceeSystemPrompt');
    let ceeSystemPromptSaveTimeout = null;
    if (ceeSystemPromptInput) {
      ceeSystemPromptInput.oninput = () => {
        if (ceeSystemPromptSaveTimeout) clearTimeout(ceeSystemPromptSaveTimeout);
        ceeSystemPromptSaveTimeout = setTimeout(() => {
          const prompt = ceeSystemPromptInput.value.trim();
          ipcRenderer.send('settings-changed', { ceeSystemPrompt: prompt });
        }, 500);
      };
      ceeSystemPromptInput.onblur = () => {
        if (ceeSystemPromptSaveTimeout) {
          clearTimeout(ceeSystemPromptSaveTimeout);
          ceeSystemPromptSaveTimeout = null;
        }
        const prompt = ceeSystemPromptInput.value.trim();
        ipcRenderer.send('settings-changed', { ceeSystemPrompt: prompt });
      };
    }

    // Trim excess messages
    function trimMessages() {
      while (messages.children.length > maxMessages) {
        messages.firstChild.remove();
      }
    }

    // Update opacity with gentle decay (stays visible longer, gradual fade)
    function updateOpacity() {
      const msgs = messages.querySelectorAll('.msg');
      const count = msgs.length;
      msgs.forEach((msg, i) => {
        const age = count - 1 - i; // 0 = newest, higher = older
        const normalizedAge = age / Math.max(1, maxMessages - 1); // 0 to 1
        // Gentle ease-out curve using cosine for smooth natural fade
        const opacity = Math.cos(Math.pow(normalizedAge, 1.3) * Math.PI / 2);
        msg.style.opacity = Math.max(0.1, opacity);
      });
    }

    // Auto-hide timeout (in ms)
    const MSG_DISPLAY_TIME = 5000;

    // Generate consistent color for username
    function getUserColor(username) {
      // Hash the username to get a consistent number
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
        hash = hash & hash; // Convert to 32bit integer
      }
      
      // Use hash to generate HSL color
      const hue = Math.abs(hash) % 360;
      const saturation = 65 + (Math.abs(hash >> 8) % 20); // 65-85%
      const lightness = 65 + (Math.abs(hash >> 16) % 15);  // 65-80%
      
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // Message ID counter (for local messages without server ID)
    let localMsgId = 0;

    // Message helpers
    function addMsg(user, text, msgId = null) {
      const id = msgId || (--localMsgId); // Use negative IDs for local messages
      
      const el = document.createElement('div');
      el.className = 'msg';
      el.dataset.msgId = id;
      el.innerHTML = `<button class="del">üóë</button><span class="user">${user}:</span><span class="text">${text}</span>`;
      
      // Apply username color
      const userEl = el.querySelector('.user');
      userEl.style.color = getUserColor(user);
      
      // Apply custom font size if set
      if (messages.dataset.fontSize) {
        const size = parseInt(messages.dataset.fontSize);
        el.style.fontSize = size + 'px';
        userEl.style.fontSize = (size - 2) + 'px';
      }
      
      // Delete button handler
      el.querySelector('.del').onclick = () => {
        deleteMessage(el);
      };
      
      // Auto-hide after display time
      setTimeout(() => {
        if (el.parentNode) {
          deleteMessage(el);
        }
      }, MSG_DISPLAY_TIME);
      
      messages.appendChild(el);
      trimMessages();
      messages.scrollTop = messages.scrollHeight;
      updateOpacity();
      updateJoinTextVisibility();
      
      return id;
    }
    
    // Delete message with animation
    function deleteMessage(el) {
      el.style.transition = 'opacity 1.3s';
      el.style.opacity = '0';
      setTimeout(() => { el.remove(); updateOpacity(); updateJoinTextVisibility(); }, 1300);
    }
    
    // Delete message by ID (from admin)
    function deleteMessageById(id) {
      const el = messages.querySelector(`[data-msg-id="${id}"]`);
      if (el) deleteMessage(el);
    }

    // Listen for messages from WebSocket server (via main process)
    ipcRenderer.on('new-message', (_, data) => {
      addMsg(data.user, data.text, data.id);
    });
    
    // Listen for message deletion from admin
    ipcRenderer.on('delete-message', (_, data) => {
      deleteMessageById(data.id);
    });
    
    // Listen for settings updates from admin
    ipcRenderer.on('settings-update', (_, settings) => {
      if (settings.hideIp !== undefined) {
        const hideIpCheckbox = $('hideIp');
        if (hideIpCheckbox) hideIpCheckbox.checked = settings.hideIp;
        // Refresh session info to get updated URLs
        initSession().then(() => {
          // Update QR code if it's currently displayed
          if (showMobileLinkCheckbox && showMobileLinkCheckbox.checked) {
            updateQRDisplay(true);
          }
        });
      }
      if (settings.maxMessages !== undefined) {
        maxMessages = settings.maxMessages;
        maxMsgSlider.value = maxMessages;
        maxMsgValue.textContent = maxMessages;
        trimMessages();
        updateOpacity();
      }
      if (settings.fontSize !== undefined) {
        fontSizeSlider.value = settings.fontSize;
        fontSizeValue.textContent = settings.fontSize;
        applyFontSize(settings.fontSize);
      }
      if (settings.showJoinCode !== undefined) {
        showJoinCode = settings.showJoinCode;
        showJoinCodeCheckbox.checked = showJoinCode;
        updateJoinTextVisibility();
      }
      if (settings.showMobileLink !== undefined) {
        showMobileLinkCheckbox.checked = settings.showMobileLink;
        updateQRDisplay(settings.showMobileLink);
      }
      if (settings.disableChatHistory !== undefined) {
        disableChatHistoryCheckbox.checked = settings.disableChatHistory;
      }
      if (settings.enableFeedbackForm !== undefined && enableFeedbackFormCheckbox) {
        enableFeedbackFormCheckbox.checked = settings.enableFeedbackForm;
      }
      if (settings.emojiDirectSend !== undefined && emojiDirectSendCheckbox) {
        emojiDirectSendCheckbox.checked = settings.emojiDirectSend;
      }
      if (settings.slowModeEnabled !== undefined && slowModeEnabledCheckbox) {
        slowModeEnabledCheckbox.checked = settings.slowModeEnabled;
        updateSlowModeVisibility();
      }
      if (settings.slowModeSeconds !== undefined) {
        const secs = parseInt(settings.slowModeSeconds, 10) || 3;
        if (slowModeSlider) slowModeSlider.value = secs;
        if (slowModeValueEl) slowModeValueEl.textContent = secs;
      }
      // @Cee Agent settings
      if (settings.enableCeeAgent !== undefined && enableCeeAgentCheckbox) {
        enableCeeAgentCheckbox.checked = settings.enableCeeAgent;
        updateCeeApiKeyVisibility();
      }
      if (settings.ceeApiProvider !== undefined) {
        updateCeeApiProviderUI(settings.ceeApiProvider);
      }
      if (settings.ceeApiKeySet !== undefined) {
        updateCeeApiKeyStatus(settings.ceeApiKeySet);
        // Update copy button visibility based on whether key is set
        if (ceeApiKeyCopy && ceeApiKeyInput) {
          ceeApiKeyCopy.classList.toggle('show', ceeApiKeyVisible && settings.ceeApiKeySet);
        }
      }
      if (settings.ceeSystemPrompt !== undefined && ceeSystemPromptInput) {
        ceeSystemPromptInput.value = settings.ceeSystemPrompt;
      }
    });

    // Get session info on startup
    function normalizeExternalUrl(url) {
      const u = String(url || '').trim();
      if (!u) return '';
      // If protocol missing, default to http (shouldn't happen, but keeps links usable).
      if (!/^https?:\/\//i.test(u)) return `http://${u}`;
      return u;
    }

    function setExternalLink(el, url) {
      if (!el) return;
      const safeUrl = normalizeExternalUrl(url);
      el.textContent = url || '';
      el.href = safeUrl || '#';
      el.onclick = (e) => {
        e.preventDefault();
        if (safeUrl) shell.openExternal(safeUrl);
      };
    }

    async function initSession() {
      try {
        const info = await ipcRenderer.invoke('get-session-info');
        $('session-code').textContent = info.code;
        const pw = $('admin-password');
        if (pw) pw.value = info.adminPassword || '';
        setExternalLink($('mobile-url'), info.mobileUrl);
        setExternalLink($('admin-url'), info.adminUrl);
        mobileUrl = info.mobileUrl;
      } catch (e) {
        console.log('Could not get session info');
      }
    }
    initSession();

    // Admin password show/hide + selectable when visible
    const adminPasswordInput = $('admin-password');
    const adminPasswordToggle = $('admin-password-toggle');
    const adminPasswordCopy = $('admin-password-copy');
    let adminPasswordVisible = false;

    function setAdminPasswordVisible(visible) {
      adminPasswordVisible = !!visible;
      if (!adminPasswordInput || !adminPasswordToggle) return;
      adminPasswordInput.type = adminPasswordVisible ? 'text' : 'password';
      adminPasswordInput.classList.toggle('visible', adminPasswordVisible);
      adminPasswordToggle.textContent = adminPasswordVisible ? 'Hide' : 'Show';
      adminPasswordToggle.setAttribute('aria-label', adminPasswordVisible ? 'Hide admin password' : 'Show admin password');
      if (adminPasswordCopy) adminPasswordCopy.classList.toggle('show', adminPasswordVisible);

      // Only allow selection/copy when visible
      if (adminPasswordVisible) {
        // Select all for quick copy
        try {
          adminPasswordInput.focus({ preventScroll: true });
          adminPasswordInput.setSelectionRange(0, adminPasswordInput.value.length);
        } catch (_) {}
      } else {
        try {
          adminPasswordInput.setSelectionRange(0, 0);
          adminPasswordInput.blur();
        } catch (_) {}
      }
    }

    if (adminPasswordToggle) {
      adminPasswordToggle.onclick = () => setAdminPasswordVisible(!adminPasswordVisible);
    }

    async function copyAdminPassword() {
      if (!adminPasswordVisible || !adminPasswordInput) return;
      const text = String(adminPasswordInput.value || '');
      if (!text) return;

      let ok = false;
      try {
        if (clipboard && clipboard.writeText) {
          clipboard.writeText(text);
          ok = true;
        }
      } catch (_) {}

      // Fallback (in case clipboard module is unavailable)
      if (!ok) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            ok = true;
          }
        } catch (_) {}
      }

      if (adminPasswordCopy) {
        // Briefly swap the icon to confirm.
        const prev = adminPasswordCopy.textContent;
        adminPasswordCopy.textContent = ok ? '‚úì' : '!';
        setTimeout(() => {
          if (adminPasswordCopy) adminPasswordCopy.textContent = prev || 'üìã';
        }, 700);
      }
    }

    if (adminPasswordCopy) {
      adminPasswordCopy.onclick = copyAdminPassword;
    }
    setAdminPasswordVisible(false);

    // Listen for open-settings command (on startup)
    ipcRenderer.on('open-settings', () => {
      openSettings();
    });

    // Show mode on start
    setTimeout(() => { mode.classList.add('show'); setTimeout(() => mode.classList.remove('show'), 2000); }, 500);
  </script>
</body>
</html>
